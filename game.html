<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å©šç¦®åŒæ­¥è·‘æ­¥æ¯”è³½ ğŸ’–</title>
<style>
body {
  text-align:center;
  font-family:"Noto Sans TC",sans-serif;
  background:#fff0f5;
  margin:0; padding:20px;
}
h1 { color:#d63384; font-size:2em; margin-bottom:20px; }
#controls { display:flex; justify-content:center; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
button { font-size:16px; padding:10px; border:none; cursor:pointer; transition:0.2s; }
button:hover { opacity:0.8; }
#joinBtn, #startBtn, #resetBtn { border-radius:12px; background:#ff8fb1; color:white; }
#runBtn { width:70px; height:70px; border-radius:50%; background:#ff6fa2; color:white; font-size:24px; line-height:70px; }
#runBtn:hover { background:#ff3f84; }
#playersList { margin-bottom:20px; font-weight:bold; color:#d63384; text-align:left; max-width:500px; margin:0 auto 20px; }
.player { margin:10px 0; position:relative; }
.progress-container { background:#ffe6f2; border-radius:12px; overflow:hidden; height:30px; border:2px solid #f9a8d4; position:relative; }
.progress-bar { height:100%; width:0%; background:#f472b6; transition: width 0.2s; }
.runner-icon { position:absolute; top:0; left:0; font-size:28px; transition:left 0.2s; }
.name-label { font-weight:bold; font-size:16px; color:#d63384; position:absolute; top:5px; left:40px; }
#winner { font-size:28px; color:green; font-weight:bold; margin-top:20px; }
#countdown { font-size:36px; color:red; font-weight:bold; margin-top:10px; }
</style>
</head>
<body>

<h1>ğŸƒ å©šç¦®åŒæ­¥è·‘æ­¥æ¯”è³½ ğŸ’–</h1>

<input id="playerName" placeholder="è¼¸å…¥åå­—" style="padding:6px; font-size:16px;">
<div id="controls">
  <button id="joinBtn">åŠ å…¥éŠæˆ²</button>
  <button id="startBtn">é–‹å§‹éŠæˆ²</button>
  <button id="resetBtn">é‡æ–°é–‹å§‹</button>
  <button id="runBtn">ğŸƒ</button>
</div>

<div id="playersList"></div>
<div id="countdown"></div>
<div id="raceArea"></div>
<div id="winner"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAQzK5BX7q7uetIKxKyf80QPkMgCee7O-g",
  authDomain: "index-63c1d.firebaseapp.com",
  databaseURL: "https://index-63c1d-default-rtdb.firebaseio.com",
  projectId: "index-63c1d",
  storageBucket: "index-63c1d.firebasestorage.app",
  messagingSenderId: "259240910482",
  appId: "1:259240910482:web:4e2d9a57fca6367848904b",
  measurementId: "G-YF4Y2S57DV"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const FINISH_LINE = 200;
let playerName = "";
let gameStarted = false;
let gameOver = false;

const joinBtn = document.getElementById("joinBtn");
const startBtn = document.getElementById("startBtn");
const resetBtn = document.getElementById("resetBtn");
const runBtn = document.getElementById("runBtn");
const playersListDiv = document.getElementById("playersList");
const raceArea = document.getElementById("raceArea");
const winnerDiv = document.getElementById("winner");
const countdownDiv = document.getElementById("countdown");

runBtn.disabled = true;

// åŠ å…¥éŠæˆ²
joinBtn.onclick = () => {
  playerName = document.getElementById("playerName").value.trim();
  if(!playerName) return alert("è«‹è¼¸å…¥åå­—ï¼");
  db.ref("players/" + playerName).set({ steps:0 });
  runBtn.disabled = true;
};

// é–‹å§‹éŠæˆ²å€’æ•¸5ç§’
startBtn.onclick = () => {
  if(gameStarted) return;
  let count = 5;
  countdownDiv.innerText = count;
  let timer = setInterval(()=>{
    count--;
    if(count>0){
      countdownDiv.innerText = count;
    } else {
      clearInterval(timer);
      countdownDiv.innerText="é–‹å§‹è·‘ï¼";
      gameStarted=true;
      runBtn.disabled=false;
      setTimeout(()=>countdownDiv.innerText="",1000);
      db.ref("gameStarted").set(true);
    }
  },1000);
};

// é‡æ–°é–‹å§‹
resetBtn.onclick = () => {
  db.ref("players").remove();
  db.ref("gameStarted").set(false);
  raceArea.innerHTML="";
  playersListDiv.innerText="";
  countdownDiv.innerText="";
  winnerDiv.innerText="";
  gameOver=false;
  gameStarted=false;
  runBtn.disabled=true;
};

// é»æˆ‘è·‘
runBtn.onclick = () => {
  if(!gameStarted || gameOver) return;
  db.ref("players/" + playerName + "/steps").transaction(s=>(s||0)+1);
};

// Firebase ç›£è½ç©å®¶é€²åº¦
db.ref("players").on("value", snapshot=>{
  const players = snapshot.val();
  if(!players){
    playersListDiv.innerText="";
    raceArea.innerHTML="";
    return;
  }

  // é¡¯ç¤ºç©å®¶åˆ—è¡¨
  playersListDiv.innerHTML = "";
  for(let name in players){
    const div = document.createElement("div");
    div.className="player";
    div.id="player-"+name;

    const label = document.createElement("div");
    label.className="name-label";
    label.innerText=name;

    const progressContainer = document.createElement("div");
    progressContainer.className="progress-container";

    const progressBar = document.createElement("div");
    progressBar.className="progress-bar";
    progressBar.id="bar-"+name;
    progressBar.style.width = Math.min(players[name].steps/FINISH_LINE*100,100)+"%";

    const runnerIcon = document.createElement("div");
    runnerIcon.className="runner-icon";
    runnerIcon.id="runner-"+name;
    runnerIcon.innerText="ğŸƒ";
    runnerIcon.style.left = Math.min(players[name].steps/FINISH_LINE*100,100)+"%";

    progressContainer.appendChild(progressBar);
    progressContainer.appendChild(runnerIcon);
    div.appendChild(label);
    div.appendChild(progressContainer);
    raceArea.appendChild(div);

    // åˆ¤æ–·å‹åˆ©
    if(players[name].steps>=FINISH_LINE && !gameOver){
      gameOver=true;
      winnerDiv.innerText="ğŸ† "+name+" ç²å‹å•¦ï¼ ğŸ‰";
    }
  }
});
</script>
</body>
</html>
