<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸƒ å©šç¦®è·‘æ­¥åŒæ­¥æ¯”è³½ ğŸ’–</title>
<style>
  body { text-align:center; font-family:"Noto Sans TC", sans-serif; background:linear-gradient(to bottom right,#ffe6f0,#fff); margin:0; padding:20px; }
  h1 { color:#d63384; font-size:2em; }
  .player { width:90%; margin:15px auto; text-align:left; position:relative; }
  .progress-container { background:#ffe6f2; border-radius:10px; overflow:hidden; height:24px; border:2px solid #f9a8d4; }
  .progress-bar { height:100%; width:0%; background:#f472b6; transition: width 0.2s; }
  .name-label { font-weight:bold; font-size:16px; color:#d63384; margin-bottom:4px; }
  input { padding:6px; border-radius:6px; border:1px solid #ccc; text-align:center; }
  button { margin:5px; padding:10px 20px; font-size:16px; border:none; border-radius:12px; background-color:#ff8fb1; color:white; cursor:pointer; transition:0.2s; }
  button:hover{background-color:#ff6fa2;}
  #countdown{font-size:36px;color:red;margin:10px;}
  #winner{font-size:28px;color:green;font-weight:bold;margin-top:20px;}
</style>
</head>
<body>

<h1>ğŸƒ å©šç¦®è·‘æ­¥åŒæ­¥æ¯”è³½ ğŸ’–</h1>

<div id="setupArea">
  <input id="playerName" placeholder="è¼¸å…¥åå­—" style="width:80%; font-size:16px;">
  <br>
  <button id="joinBtn">åŠ å…¥éŠæˆ²</button>
</div>

<div id="gameArea" style="display:none;">
  <div id="raceArea"></div>
  <div id="countdown"></div>
  <div id="winner"></div>
  <button id="startBtn">é–‹å§‹éŠæˆ²</button>
  <button id="resetBtn">é‡æ–°é–‹å§‹</button>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
  // ğŸ”‘ Firebase é…ç½®
  var firebaseConfig = {
    apiKey: "AIzaSyAQzK5BX7q7uetIKxKyf80QPkMgCee7O-g",
    authDomain: "index-63c1d.firebaseapp.com",
    databaseURL: "https://index-63c1d-default-rtdb.firebaseio.com",
    projectId: "index-63c1d",
    storageBucket: "index-63c1d.firebasestorage.app",
    messagingSenderId: "259240910482",
    appId: "1:259240910482:web:4e2d9a57fca6367848904b",
    measurementId: "G-YF4Y2S57DV"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const FINISH_LINE = 200;
  let playerName = "";
  let gameStarted = false;
  let gameOver = false;

  const raceArea = document.getElementById("raceArea");
  const countdownDiv = document.getElementById("countdown");
  const winnerDiv = document.getElementById("winner");
  const joinBtn = document.getElementById("joinBtn");
  const startBtn = document.getElementById("startBtn");

  // åŠ å…¥éŠæˆ²
  joinBtn.onclick = () => {
    playerName = document.getElementById("playerName").value.trim();
    if(!playerName) return alert("è«‹è¼¸å…¥åå­—ï¼");
    db.ref("players/" + playerName).set({ steps: 0 });
    document.getElementById("setupArea").style.display="none";
    document.getElementById("gameArea").style.display="block";
    alert("åŠ å…¥æˆåŠŸï¼ç­‰å¾…ä¸»æŒäººé–‹å§‹æ¯”è³½...");
  };

  // é»æ“Šè·‘æ­¥
  function move() {
    if(!gameStarted || gameOver) return;
    db.ref("players/" + playerName + "/steps").transaction(s => (s||0)+1);
  }

  // é–‹å§‹æ¯”è³½ï¼ˆä¸»æŒäººï¼‰
  startBtn.onclick = () => {
    if(gameStarted) return;
    let count = 3;
    countdownDiv.innerText = count;
    let timer = setInterval(()=>{
      count--;
      if(count>0) countdownDiv.innerText=count;
      else{
        clearInterval(timer);
        countdownDiv.innerText="é–‹å§‹ï¼";
        db.ref("gameStarted").set(true);
        setTimeout(()=>countdownDiv.innerText="",1000);
      }
    },1000);
  };

  // é‡ç½®
  document.getElementById("resetBtn").onclick = () => {
    db.ref("players").remove();
    db.ref("gameStarted").set(false);
    db.ref("gameOver").set(false);
    raceArea.innerHTML="";
    winnerDiv.innerText="";
    document.getElementById("setupArea").style.display="block";
    document.getElementById("gameArea").style.display="none";
    gameStarted=false;
    gameOver=false;
  };

  // ç›£è½éŠæˆ²é–‹å§‹
  db.ref("gameStarted").on("value",snap=>{
    gameStarted = snap.val();
  });

  // ç›£è½ç©å®¶è³‡æ–™ä¸¦ç”Ÿæˆè·‘æ­¥æŒ‰éˆ•
  db.ref("players").on("value",snap=>{
    raceArea.innerHTML="";
    const players = snap.val();
    if(!players) return;
    for(let name in players){
      let steps = players[name].steps;
      let percent = Math.min((steps/FINISH_LINE)*100,100);

      let div=document.createElement("div");
      div.className="player";

      let label=document.createElement("div");
      label.className="name-label";
      label.innerText=name + " ("+steps+")";

      let barContainer=document.createElement("div");
      barContainer.className="progress-container";

      let bar=document.createElement("div");
      bar.className="progress-bar";
      bar.style.width=percent+"%";

      barContainer.appendChild(bar);
      div.appendChild(label);
      div.appendChild(barContainer);
      raceArea.appendChild(div);

      // ç”¢ç”Ÿé»æˆ‘è·‘æŒ‰éˆ•ï¼ˆåªçµ¦è‡ªå·±çš„åå­—ï¼‰
      if(name===playerName){
        let btn=document.createElement("button");
        btn.innerText="ğŸƒ é»æˆ‘è·‘ï¼";
        btn.onclick=move;
        raceArea.appendChild(btn);
      }

      // åˆ¤æ–·å‹åˆ©
      if(steps>=FINISH_LINE && !gameOver){
        gameOver=true;
        db.ref("gameOver").set(true);
        winnerDiv.innerText="ğŸ† "+name+" ç²å‹å•¦ï¼ ğŸ‰";
      }
    }
  });

  // ç›£è½éŠæˆ²çµæŸ
  db.ref("gameOver").on("value",snap=>{
    gameOver = snap.val();
  });
</script>
</body>
</html>
