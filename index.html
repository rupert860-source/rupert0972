<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🏃 婚禮跑步同步比賽 💖</title>
<style>
  body { text-align:center; font-family:"Noto Sans TC", sans-serif; background:linear-gradient(to bottom right,#ffe6f0,#fff); margin:0; padding:20px; }
  h1 { color:#d63384; font-size:2em; }
  .player { width:90%; margin:15px auto; text-align:left; position:relative; }
  .progress-container { background:#ffe6f2; border-radius:10px; overflow:hidden; height:24px; border:2px solid #f9a8d4; }
  .progress-bar { height:100%; width:0%; background:#f472b6; transition: width 0.2s; }
  .name-label { font-weight:bold; font-size:16px; color:#d63384; margin-bottom:4px; }
  input { padding:6px; border-radius:6px; border:1px solid #ccc; text-align:center; }
  button { margin:5px; padding:10px 20px; font-size:16px; border:none; border-radius:12px; background-color:#ff8fb1; color:white; cursor:pointer; transition:0.2s; }
  button:hover{background-color:#ff6fa2;}
  #countdown{font-size:36px;color:red;margin:10px;}
  #winner{font-size:28px;color:green;font-weight:bold;margin-top:20px;}
</style>
</head>
<body>

<h1>🏃 婚禮跑步同步比賽 💖</h1>

<div id="setupArea">
  <input id="playerName" placeholder="輸入名字" style="width:80%; font-size:16px;">
  <br>
  <button id="joinBtn">加入遊戲</button>
</div>

<div id="gameArea" style="display:none;">
  <div id="raceArea"></div>
  <div id="countdown"></div>
  <div id="winner"></div>
  <button id="startBtn">開始遊戲</button>
  <button id="resetBtn">重新開始</button>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
  // 🔑 Firebase 配置
  var firebaseConfig = {
    apiKey: "AIzaSyAQzK5BX7q7uetIKxKyf80QPkMgCee7O-g",
    authDomain: "index-63c1d.firebaseapp.com",
    databaseURL: "https://index-63c1d-default-rtdb.firebaseio.com",
    projectId: "index-63c1d",
    storageBucket: "index-63c1d.firebasestorage.app",
    messagingSenderId: "259240910482",
    appId: "1:259240910482:web:4e2d9a57fca6367848904b",
    measurementId: "G-YF4Y2S57DV"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const FINISH_LINE = 200;
  let playerName = "";
  let gameStarted = false;
  let gameOver = false;

  const raceArea = document.getElementById("raceArea");
  const countdownDiv = document.getElementById("countdown");
  const winnerDiv = document.getElementById("winner");
  const joinBtn = document.getElementById("joinBtn");
  const startBtn = document.getElementById("startBtn");

  // 加入遊戲
  joinBtn.onclick = () => {
    playerName = document.getElementById("playerName").value.trim();
    if(!playerName) return alert("請輸入名字！");
    db.ref("players/" + playerName).set({ steps: 0 });
    document.getElementById("setupArea").style.display="none";
    document.getElementById("gameArea").style.display="block";
    alert("加入成功！等待主持人開始比賽...");
  };

  // 點擊跑步
  function move() {
    if(!gameStarted || gameOver) return;
    db.ref("players/" + playerName + "/steps").transaction(s => (s||0)+1);
  }

  // 開始比賽（主持人）
  startBtn.onclick = () => {
    if(gameStarted) return;
    let count = 3;
    countdownDiv.innerText = count;
    let timer = setInterval(()=>{
      count--;
      if(count>0) countdownDiv.innerText=count;
      else{
        clearInterval(timer);
        countdownDiv.innerText="開始！";
        db.ref("gameStarted").set(true);
        setTimeout(()=>countdownDiv.innerText="",1000);
      }
    },1000);
  };

  // 重置
  document.getElementById("resetBtn").onclick = () => {
    db.ref("players").remove();
    db.ref("gameStarted").set(false);
    db.ref("gameOver").set(false);
    raceArea.innerHTML="";
    winnerDiv.innerText="";
    document.getElementById("setupArea").style.display="block";
    document.getElementById("gameArea").style.display="none";
    gameStarted=false;
    gameOver=false;
  };

  // 監聽遊戲開始
  db.ref("gameStarted").on("value",snap=>{
    gameStarted = snap.val();
  });

  // 監聽玩家資料並生成跑步按鈕
  db.ref("players").on("value",snap=>{
    raceArea.innerHTML="";
    const players = snap.val();
    if(!players) return;
    for(let name in players){
      let steps = players[name].steps;
      let percent = Math.min((steps/FINISH_LINE)*100,100);

      let div=document.createElement("div");
      div.className="player";

      let label=document.createElement("div");
      label.className="name-label";
      label.innerText=name + " ("+steps+")";

      let barContainer=document.createElement("div");
      barContainer.className="progress-container";

      let bar=document.createElement("div");
      bar.className="progress-bar";
      bar.style.width=percent+"%";

      barContainer.appendChild(bar);
      div.appendChild(label);
      div.appendChild(barContainer);
      raceArea.appendChild(div);

      // 產生點我跑按鈕（只給自己的名字）
      if(name===playerName){
        let btn=document.createElement("button");
        btn.innerText="🏃 點我跑！";
        btn.onclick=move;
        raceArea.appendChild(btn);
      }

      // 判斷勝利
      if(steps>=FINISH_LINE && !gameOver){
        gameOver=true;
        db.ref("gameOver").set(true);
        winnerDiv.innerText="🏆 "+name+" 獲勝啦！ 🎉";
      }
    }
  });

  // 監聽遊戲結束
  db.ref("gameOver").on("value",snap=>{
    gameOver = snap.val();
  });
</script>
</body>
</html>
